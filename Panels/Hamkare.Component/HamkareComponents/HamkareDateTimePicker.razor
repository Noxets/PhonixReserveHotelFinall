@inherits MudDatePicker

@if (OnRender)
{
    <HamkareSkeletonInput HaveHelper="!string.IsNullOrWhiteSpace(HelperText)"/>
}
else
{
    base.BuildRenderTree(__builder);
}

@code {
    [Parameter] public bool OnRender { get; set; } = true;
    [Parameter] public int MinuteSelectionStep { get; set; }

    private bool OpenedTimePicker { get; set; } = true;
    private TimeSpan? Time { get; set; }

    public override async Task SetParametersAsync(ParameterView parameters)
    {
        Culture = parameters.TryGetValue("Culture", out CultureInfo culture) ? culture : Thread.CurrentThread.CurrentUICulture;
        Margin = parameters.TryGetValue("Margin", out Margin margin) ? margin : Margin.Dense;
        Variant = parameters.TryGetValue("Variant", out Variant variant) ? variant : Variant.Outlined;
        AnchorOrigin = parameters.TryGetValue("AnchorOrigin", out Origin anchorOrigin) ? anchorOrigin : Origin.CenterCenter;
        TransformOrigin = parameters.TryGetValue("TransformOrigin", out Origin transformOrigin) ? transformOrigin : Origin.CenterCenter;
        PickerVariant = parameters.TryGetValue("PickerVariant", out PickerVariant pickerVariant) ? pickerVariant : PickerVariant.Dialog;
        DateFormat = parameters.TryGetValue("DateFormat", out string dateFormat) ? dateFormat : Thread.CurrentThread.CurrentUICulture.IsRtl() ? "HH:mm yyyy/MM/dd" : "HH:mm MM/dd/yyyy";
        MinuteSelectionStep = parameters.TryGetValue("MinuteSelectionStep", out int minuteSelectionStep) ? minuteSelectionStep : 5;
        AutoClose = true;
        Editable = false;
        Date = parameters.TryGetValue("Date", out DateTime? date) ? date ?? DateTime.Now : DateTime.Now;
        if (OpenedTimePicker)
            Time = Date?.TimeOfDay;

        PickerActions = value => @<div>
                                     <HamkareTimePicker Class="@(OpenedTimePicker ? "" : "d-none")" Open="OpenedTimePicker" AutoClose="true" Time="Time" TimeChanged="ChangeTime" Editable="false" PickerClosed="() => OpenedTimePicker = false" OnRender="false" OpenTo="OpenTo.Hours" MinuteSelectionStep="MinuteSelectionStep"/>
                                     <HamkareButton OnClick="() => OpenedTimePicker = true" Class="d-flex w-100 justify-content-between">
                                         <HamkareText OnRender="OnRender">
                                             @(Date.HasValue ? Date.Value.ToString("HH:mm") : "")
                                         </HamkareText>
                                         <MudIcon Icon="@Icons.Material.Outlined.Alarm"/>
                                     </HamkareButton>
                                 </div>;


        await base.SetParametersAsync(parameters);
    }

    protected override async Task OnPickerClosedAsync()
    {
        if (!OpenedTimePicker)
        {
            if (Date.HasValue && Time.HasValue)
                Date = Date.Value.Date.AddMinutes(Time.Value.TotalMinutes);
            await base.OnPickerClosedAsync();
        }
    }

    private void ChangeTime(TimeSpan? obj)
    {
        Time = obj;

        if (Date.HasValue && obj.HasValue)
            Date = Date.Value.Date.AddMinutes(obj.Value.TotalMinutes);
    }

}