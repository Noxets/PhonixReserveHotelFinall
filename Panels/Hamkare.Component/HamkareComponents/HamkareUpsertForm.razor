@typeparam T where T : new()
@attribute [CascadingTypeParameter("T")]
@inject NavigationManager NavigationManager

<PageTitle>@Title</PageTitle>

<MudPaper Outlined="false" Elevation="0" Class="pa-4 rounded-lg full-height">

    <MudStack Row="true" Class="w-100 rounded-lg mb-4 stack-title-table" AlignItems="AlignItems.Center">

        <MudItem xs="2">
            <MudTooltip Text="@GlobalResources.Return" Placement="Placement.Bottom" Arrow="true">
                <MudIconButton Href="@ReturnUrl" Class="rounded-lg"
                               Icon="@(Thread.CurrentThread.CurrentUICulture.IsRtl() ? Icons.Material.TwoTone.ArrowForward : Icons.Material.TwoTone.ArrowBack)">
                </MudIconButton>
            </MudTooltip>
        </MudItem>

        <MudItem xs="8">
            <MudText Typo="Typo.h6" Align="Align.Center">@Title</MudText>
        </MudItem>

        <MudItem xs="2"></MudItem>

    </MudStack>

    <MudForm Model="@Model" @ref="@_form" ValidationDelay="0" Class="form-fix-button">

        <MudGrid>

            @Body

        </MudGrid>

    </MudForm>

    <MudAppBar Bottom="true" Fixed="true" Elevation="0" Class="px-4 z-1 mb-4" Gutters="false">

        <MudPaper Class="w-100 h-100 d-flex align-items-center px-4 gap-3 rounded-lg" Elevation="0">

            <HamkareButton Variant="Variant.Filled" Class="rounded-lg" Color="Color.Primary"
                           OnClick="@(async () => await Submit())" @onkeydown="@HandleKeyDown">
                @ViewResources.Submit
            </HamkareButton>

            <HamkareButton Variant="Variant.Outlined" Class="rounded-lg" Color="Color.Primary"
                           OnClick="@(async () => await SubmitAndNews())">
                @ViewResources.SubmitAndNew
            </HamkareButton>

            <HamkareButton Variant="Variant.Text" Class="rounded-lg" Color="Color.Primary" Href="@ReturnUrl">
                @GlobalResources.Cancel
            </HamkareButton>

        </MudPaper>

    </MudAppBar>

</MudPaper>

@code{
    private MudForm _form;

    private async Task Submit()
    {
        try
        {
            await _form.Validate();

            if (_form.IsValid)
            {
                var result = await OnSubmit();
                if (result)
                    NavigationManager.NavigateTo(ReturnUrl);
            }
        }
        catch (Exception e)
        {
            await JsRuntime.LogError(e);
            Snackbar.Error(EntitiesResources.Product);
        }
    }

    private async Task SubmitAndNews()
    {
        try
        {
            await _form.Validate();

            if (_form.IsValid)
            {
                var result = await OnSubmit();
                if (result)
                    NavigationManager.NavigateTo(NavigationManager.Uri, true);
            }
        }
        catch (Exception e)
        {
            await JsRuntime.LogError(e);
            Snackbar.Error(EntitiesResources.Product);
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.CtrlKey && !e.ShiftKey)
        {
            await Submit();
        }
    }

    #region Parameter

    [Parameter] public string Title { get; set; }

    [Parameter] public string ReturnUrl { get; set; }

    [Parameter] public RenderFragment Body { get; set; }

    [Parameter] public Func<Task<bool>> OnSubmit { get; set; }

    [Parameter] public T Model { get; set; }

    [Parameter] public bool OnRender { get; set; } = true;

    #endregion

}