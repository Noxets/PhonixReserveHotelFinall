@typeparam T
@attribute [CascadingTypeParameter("T")]

<PageTitle>@Title</PageTitle>

<MudPaper Elevation="0" Class="h-100 p-3 rounded-lg CustomDataGrid">

    <HamkareHeaderPage Title="@Title" OnRender="OnRender" ReturnLink="@ReturnLink">
        <Buttons>
        </Buttons>
    </HamkareHeaderPage>

    <HamkareDataGrid @ref="@Grid" T="T" Items="Element" QuickFilter="QuickFilter" RowClick="e => OpenDialog(e.Item)"
                     Loading="OnRender">

        <ToolBarContent >

            <HamkareTextField T="string" ValueChanged="Callback" Placeholder="@GlobalResources.Search"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.TwoTone.Search" IconSize="Size.Medium" Class="input-mt-0"
                              OnRender="OnRender"/>

            <MudSpacer/>

            @if (Grid.SelectedItems.Any())
            {
                // Todo: Hamid
                <MudTooltip Text="تعداد انتخاب شده" Placement="Placement.Bottom"
                            Arrow="true">
                    <MudText Color="Color.Primary">@Grid.SelectedItems.Count</MudText>
                </MudTooltip>

                if (OnActives.HasDelegate)
                {
                    // Todo: Hamid
                    <MudTooltip Text="@(Actives ? GlobalResources.Active : GlobalResources.Inactive)"
                                Placement="Placement.Bottom" Arrow="true">
                        <MudToggleIconButton Class="action-button-dataGrid rounded-lg" Toggled="Actives"
                                             Icon="@Icons.Material.TwoTone.CheckBoxOutlineBlank" Color="@Color.Error"
                                             ToggledIcon="@Icons.Material.TwoTone.Check" ToggledColor="@Color.Success"
                                             ToggledChanged="() => ActivesChange()"
                                             Variant="Variant.Text"/>
                    </MudTooltip>
                }

                if (OnDeletes.HasDelegate)
                {
                    // Todo: Hamid
                    <MudTooltip Text="حذف موارد انتخاب شده" Placement="Placement.Bottom"
                                Arrow="true">
                        <MudIconButton Class="action-button-dataGrid rounded-lg" Size="@Size.Small" Variant="Variant.Text"
                                       Icon="@Icons.Material.Outlined.Delete" Color="Color.Error"
                                       OnClick="@(_ => OnDeletes.InvokeAsync(new List<T>(Grid.SelectedItems)))"/>
                    </MudTooltip>
                }
            }

            @if (!string.IsNullOrEmpty(AddLink))
            {
                <MudHidden Breakpoint="Breakpoint.Xs" Invert="true">
                    <MudIconButton Href=@(AddLink) Color="Color.Primary"
                                   Variant="Variant.Outlined" Icon="@Icons.Material.Rounded.Add"
                                   Class="rounded-lg ms-3">
                    </MudIconButton>
                </MudHidden>

                <MudHidden Breakpoint="Breakpoint.SmAndUp" Invert="true">

                    <MudButton Href=@(AddLink)
                               Size="Size.Large" Color="Color.Primary"
                               Variant="Variant.Outlined" EndIcon="@Icons.Material.Rounded.Add"
                               Class="rounded-lg">
                        @GlobalResources.Add
                    </MudButton>
                </MudHidden>
            }

            @ButtonPlace

        </ToolBarContent>

        <Columns>
            @if (OnActives.HasDelegate || OnDeletes.HasDelegate)
            {
                <SelectColumn T="T"/>
            }
            @Columns

        </Columns>

        <PagerContent>
            <HamkareDataGridPager T="T" InfoFormat="@GlobalResources.PagesCountOf"
                                  PageSizeOptions="@(Element.Count() > 100 ? [10, 25, 50, 100, int.MaxValue] : [10, 25, 50, 100])"
                                  RowsPerPageString="@GlobalResources.PageCount"
                                  Class="d-flex justify-content-center align-items-center"/>
        </PagerContent >

    </HamkareDataGrid>
</MudPaper>

<MudDialog @bind-Visible="@Visible" Options="_dialogOptions" Class="rounded-lg">

    <TitleContent>
        <MudText Typo="Typo.h6" Color="Color.Primary">
            @GlobalResources.Detail
        </MudText>
    </TitleContent>

    <DialogContent>

        <HamkareListItemDialog T="T" Model="DialogModel"/>

    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Default" DropShadow="true" OnClick="@(CloseDialog)"
                   Class="px-10 m-1">
            @GlobalResources.Return
        </MudButton>
    </DialogActions>

</MudDialog>


@code{
    private HamkareDataGrid<T> Grid { get; set; }
    private bool Actives { get; set; } = true;

    #region Parameter

    [Parameter] public string Title { get; set; }

    [Parameter] public string ReturnLink { get; set; }

    [Parameter] public string AddLink { get; set; }

    [Parameter] public IEnumerable<T> Element { get; set; } = new List<T>();

    [Parameter] public Func<T, bool> QuickFilter { get; set; }

    [Parameter] public bool OnRender { get; set; } = true;

    [Parameter] public string SearchString { get; set; }

    [Parameter] public EventCallback<string> SearchStringChange { get; set; }

    [Parameter] public RenderFragment Columns { get; set; }

    [Parameter] public RenderFragment ButtonPlace { get; set; }

    [Parameter] public EventCallback<(List<T>, bool)> OnActives { get; set; }

    [Parameter] public EventCallback<List<T>> OnDeletes { get; set; }

    #endregion

    #region Dialog

    private T DialogModel { get; set; }

    private bool Visible { get; set; }

    private void OpenDialog(T item)
    {
        DialogModel = item;
        Visible = true;
    }

    void CloseDialog() => Visible = false;

    private readonly DialogOptions _dialogOptions = new()
    {
        FullWidth = true
    };

    #endregion

    private void Callback(string search)
    {
        SearchString = search;
        SearchStringChange.InvokeAsync(search);
    }

    private void ActivesChange()
    {
        Actives = !Actives;
        OnActives.InvokeAsync(([..Grid.SelectedItems], Actives));
    }

}