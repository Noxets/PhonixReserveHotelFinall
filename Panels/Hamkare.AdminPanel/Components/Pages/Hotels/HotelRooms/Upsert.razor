@page "/AdminPanel/HotelRoom/Upsert/{HotelId:long}"
@page "/AdminPanel/HotelRoom/Upsert/{HotelId:long}/{Id:long}"
@using Hamkare.Common.Entities
@using Hamkare.Resource
@using Hamkare.Utility.Extensions
@using Hamkare.Component.HamkareComponents
@using Hamkare.Infrastructure
@using Hamkare.Service.Services.Generic
@using Microsoft.AspNetCore.Hosting
@inject RootService<HotelRoom,ApplicationDbContext> HotelRoomService
@inject IWebHostEnvironment WebHostEnvironment

<HamkareUpsertForm T="HotelRoom" OnRender="OnRender" OnSubmit="Submit" ReturnUrl="@($"/adminPanel/HotelRoom/{HotelId}")" Model="_model" Title="@(Id==0 ? $"{GlobalResources.Add} HotelRoom" : $"{GlobalResources.Edit} HotelRoom")">

    <Body>

    <MudItem xs="12" md="6" lg="3">

        <HamkareTextField OnRender="OnRender" @bind-Value="_model.RoomNumber" For="@(() => _model.RoomNumber)" Label="RoomNumber" Counter="2000" MaxLength="2000"/>

    </MudItem>
    
    <MudItem xs="12" md="6" lg="3">

        <HamkareNumericField OnRender="OnRender" @bind-Value="_model.Bed" For="@(() => _model.Bed)"
                             Label="Bed" />

    </MudItem>
    
    <MudItem xs="12" md="6" lg="3">

        <HamkareNumericField OnRender="OnRender" @bind-Value="_model.Price" For="@(() => _model.Price)"
                             Label="@GlobalResources.Price" />

    </MudItem>
    
    <MudItem xs="12" md="6" lg="3">

        <HamkareNumericField OnRender="OnRender" @bind-Value="_model.Discount" For="@(() => _model.Discount)"
                             Label="@GlobalResources.Discount" />

    </MudItem>
    
    <MudItem xs="12" md="6" lg="3">

        <HamkareNumericField OnRender="OnRender" @bind-Value="_model.Tax" For="@(() => _model.Tax)"
                             Label="@GlobalResources.Tax" />

    </MudItem>
    
    <MudItem xs="12">

        <MudGrid Justify="Justify.Center">
                
            <MudItem xs="12">
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.FlexEnd">
                    <MudFileUpload T="IBrowserFile" FilesChanged="@(e => UploadFileImage(e))" Accept="@FileExtension.ImageFormatString" Class="mt-0">
                        <ActivatorContent>
                            <MudButton HtmlTag="label"
                                       Variant="Variant.Filled"
                                       Class="rounded-lg"
                                       DropShadow="true"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.TwoTone.CloudUpload">
                                @GlobalResources.Images
                            </MudButton>
                        </ActivatorContent>
                    </MudFileUpload>
                </MudStack>

            </MudItem>
                
            @foreach (var item in _model.Images)
            {
                <MudItem xs="12" md="6" lg="3">
                    <MudIconButton Icon="@Icons.Material.TwoTone.Delete" Variant="Variant.Outlined" OnClick="@(() => _model.Images.Remove(item))" Color="Color.Error" Size="Size.Medium" Class="DisplayImages-Remove-Button rounded-lg"></MudIconButton>
                    <MudStack Class="p-2" Spacing="2">

                        <MudImage Src="@($"/Upload/HotelRoom/{item}")" Elevation="25" Class="img-fluid rounnded-lg"></MudImage>
                        <MudText>@($"/Upload/HotelRoom/{item}")</MudText>
                    </MudStack>
                </MudItem>
            }
        </MudGrid>
    </MudItem>

    </Body>

</HamkareUpsertForm>

@code{
    
    private HotelRoom _model = new();
    [Parameter]
    public long Id { get; set; }
    
    public long HotelId { get; set; }

    public bool OnRender { get; set; } = true;
    protected override async Task OnInitializedAsync()
    {
        if (Id != 0)
        {
            _model = await HotelRoomService.FindAsync(Id);
        }

        _model.HotelId = HotelId;
        
        OnRender = false;
    }

    private async Task<bool> Submit()
    {
        try
        {
            if (_model.Validate(out var errors))
            {
                Snackbar.Error(errors);
                return false;
            }
            
            await HotelRoomService.AddOrUpdateAsync(_model);
            Snackbar.SuccessAddOrUpdate("HotelRoom");
            return true;
        }
        catch (Exception e)
        {
            await JsRuntime.LogError(e);
            e.ShowErrorSnackbar(Snackbar, "HotelRoom");
        }

        return false;
    }
    
    private async Task UploadFileImage(IBrowserFile uploadedFiles)
    {
        // if (uploadedFiles.ValidateImage(Type.Width, Type.Height))
        _model.Images.Add(await uploadedFiles.AddFile(WebHostEnvironment, "HotelRoom"));
        // else
        // Snackbar.Error($"سایز تصویر مورد نظر باید {Type.Width} در {Type.Height}باشد");
    }


}